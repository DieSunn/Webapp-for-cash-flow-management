{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{% if form.instance.pk %}Редактирование{% else %}Создание{% endif %} записи</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

    <div class="card shadow p-4">
        <h2 class="mb-4">{% if form.instance.pk %}Редактировать{% else %}Создать{% endif %} запись</h2>

        <form method="post" novalidate>
            {% csrf_token %}

            <!-- Ошибки формы -->
            {% if form.errors %}
            <div class="alert alert-danger">
                <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li><b>{{ field }}</b>: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Дата</label>
                    {{ form.created_at }}
                </div>

                <div class="col-md-4">
                    <label class="form-label">Статус</label>
                    {{ form.status }}
                </div>

                <div class="col-md-4">
                    <label class="form-label">Тип</label>
                    {{ form.type }}
                </div>

                <div class="col-md-6">
                    <label class="form-label">Категория</label>
                    {{ form.category }}
                </div>

                <div class="col-md-6">
                    <label class="form-label">Подкатегория</label>
                    {{ form.subcategory }}
                </div>

                <div class="col-md-6">
                    <label class="form-label">Сумма</label>
                    {{ form.amount }}
                </div>

                <div class="col-md-12">
                    <label class="form-label">Комментарий</label>
                    {{ form.comment }}
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'cashflow_list' %}" class="btn btn-secondary">⬅ Назад</a>
                <button type="submit" class="btn btn-success">
                    {% if form.instance.pk %}Сохранить{% else %}Создать{% endif %}
                </button>
            </div>
        </form>
    </div>

    <script>
    // Bootstrap валидация формы
    (() => {
      'use strict'
      const forms = document.querySelectorAll('form')
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          }
          form.classList.add('was-validated')
        }, false)
      })
    })()

    // Динамическая фильтрация категорий и подкатегорий
    document.addEventListener("DOMContentLoaded", function() {
        const typeSelect = document.getElementById("id_type");
        const categorySelect = document.getElementById("id_category");
        const subcategorySelect = document.getElementById("id_subcategory");

        function filterCategories() {
            const typeId = typeSelect.value;
            let firstVisible = null;
            categorySelect.querySelectorAll("option").forEach(opt => {
                if (opt.dataset.type && opt.dataset.type !== typeId) {
                    opt.style.display = "none";
                    if (opt.selected) opt.selected = false;
                } else {
                    opt.style.display = "block";
                    if (!firstVisible) firstVisible = opt;
                }
            });
            if (firstVisible && !categorySelect.value) firstVisible.selected = true;
            filterSubcategories();
        }

        function filterSubcategories() {
            const categoryId = categorySelect.value;
            let firstVisible = null;
            subcategorySelect.querySelectorAll("option").forEach(opt => {
                if (opt.dataset.category && opt.dataset.category !== categoryId) {
                    opt.style.display = "none";
                    if (opt.selected) opt.selected = false;
                } else {
                    opt.style.display = "block";
                    if (!firstVisible && opt.value) firstVisible = opt;
                }
            });
        }

        typeSelect.addEventListener("change", filterCategories);
        categorySelect.addEventListener("change", filterSubcategories);

        // при загрузке страницы
        filterCategories();
        filterSubcategories();
    });
    </script>
</body>
</html>
